name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        platforms: android-34
        cmdline-tools: latest
        
    - name: Build APK with Android Tools
      run: |
        cd app
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 compile -o compiled_resources res/**/*.xml
        
        echo "üîß –õ–∏–Ω–∫–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o resources.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest AndroidManifest.xml \
          compiled_resources/*.flat
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è Java –∫–æ–¥–∞..."
        mkdir -p obj
        javac -d obj \
          -cp "src:$ANDROID_HOME/platforms/android-34/android.jar" \
          -sourcepath src \
          src/com/example/internetprovider/*.java
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ DEX —Ñ–∞–π–ª–∞..."
        $ANDROID_HOME/build-tools/34.0.0/d8 \
          --lib $ANDROID_HOME/platforms/android-34/android.jar \
          --output . \
          obj/com/example/internetprovider/*.class
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ APK..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o app-debug.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest AndroidManifest.xml \
          compiled_resources/*.flat \
          --java src
        
        echo "üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DEX –≤ APK..."
        zip -uj app-debug.apk classes.dex
        
        echo "‚úÖ APK —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: internet-provider-app
        path: app/app-debug.apk
        retention-days: 30
