name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        platforms: android-34
        
    - name: Build APK with AAPT2
      run: |
        cd app
        
        echo "ðŸ”§ ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÑÑƒÑ€ÑÑ‹..."
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
        mkdir -p build/res
        
        # ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ XML Ñ€ÐµÑÑƒÑ€ÑÑ‹
        $ANDROID_HOME/build-tools/34.0.0/aapt2 compile \
          -o build/res/ \
          src/main/res/layout/activity_main.xml \
          src/main/res/values/strings.xml
        
        echo "ðŸ”§ Ð›Ð¸Ð½ÐºÑƒÐµÐ¼ Ñ€ÐµÑÑƒÑ€ÑÑ‹..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link \
          -o build/resources.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest AndroidManifest.xml \
          --java build/generated \
          build/res/*.flat
        
        echo "ðŸ”§ ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ Java ÐºÐ¾Ð´..."
        mkdir -p build/obj
        javac -d build/obj \
          -cp "src/main/java:$ANDROID_HOME/platforms/android-34/android.jar" \
          -sourcepath src/main/java \
          src/main/java/com/example/internetprovider/MainActivity.java
        
        echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ DEX Ñ„Ð°Ð¹Ð»..."
        $ANDROID_HOME/build-tools/34.0.0/d8 \
          --lib $ANDROID_HOME/platforms/android-34/android.jar \
          --output build/ \
          build/obj/com/example/internetprovider/*.class
        
        echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ APK..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o build/app-debug.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest AndroidManifest.xml \
          build/res/*.flat
        
        echo "ðŸ”§ Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ DEX Ð² APK..."
        cd build
        zip -uj app-debug.apk classes.dex
        cd ..
        
        echo "âœ… APK ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½!"
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: internet-provider-app
        path: app/build/app-debug.apk
        retention-days: 30
        
    - name: Show build info
      run: |
        echo "ðŸ“ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°:"
        find app -type f -name "*.java" -o -name "*.xml" | head -10
        echo "ðŸ“¦ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ build Ð¿Ð°Ð¿ÐºÐ¸:"
        ls -la app/build/ 2>/dev/null || echo "Build folder not found"
