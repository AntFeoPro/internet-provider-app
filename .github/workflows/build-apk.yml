name: Build Internet Provider App

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
      
    - name: Install Android packages
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-33" "build-tools;33.0.2" "platform-tools"
    
    - name: Create complete project structure
      run: |
        # Clean and create structure
        rm -rf app/
        mkdir -p app/src/main/java/com/example/internetprovider
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/res/values
        mkdir -p app/src/main/res/drawable
        
        # Create proper AndroidManifest.xml
        cat > app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.internetprovider">

    <uses-permission android:name="android.permission.INTERNET" />
    
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:theme="@android:style/Theme.Material.Light.DarkActionBar">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:label="@string/app_name">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF

        # Create strings.xml
        cat > app/src/main/res/values/strings.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">Ð˜Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚ ÐŸÑ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€</string>
</resources>
EOF

        # Create proper layout file
        cat > app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:padding="16dp">

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Ð˜Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚ ÐŸÑ€Ð¾Ð²Ð°Ð¹Ð´ÐµÑ€"
        android:textSize="24sp"
        android:textStyle="bold"
        android:gravity="center"
        android:layout_marginBottom="24dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Ð¢Ð°Ñ€Ð¸Ñ„Ñ‹:"
        android:textSize="20sp"
        android:textStyle="bold"
        android:layout_marginBottom="8dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="â€¢ Ð§Ð°ÑÑ‚Ð½Ñ‹Ð¹ ÑÐµÐºÑ‚Ð¾Ñ€: 100 ÐœÐ±Ð¸Ñ‚/Ñ - 500 Ñ€ÑƒÐ±/Ð¼ÐµÑ"
        android:layout_marginBottom="4dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="â€¢ ÐœÐ½Ð¾Ð³Ð¾ÐºÐ²Ð°Ñ€Ñ‚Ð¸Ñ€Ð½Ñ‹Ð¹ Ð´Ð¾Ð¼: 200 ÐœÐ±Ð¸Ñ‚/Ñ - 700 Ñ€ÑƒÐ±/Ð¼ÐµÑ"
        android:layout_marginBottom="4dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="â€¢ Ð®Ñ€Ð¸Ð´Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð»Ð¸Ñ†Ð°: 500 ÐœÐ±Ð¸Ñ‚/Ñ - 2000 Ñ€ÑƒÐ±/Ð¼ÐµÑ"
        android:layout_marginBottom="16dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹:"
        android:textSize="20sp"
        android:textStyle="bold"
        android:layout_marginBottom="8dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: +7 (123) 456-78-90"
        android:layout_marginBottom="4dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Email: support@provider.ru"
        android:layout_marginBottom="4dp" />

    <TextView
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="ÐÐ´Ñ€ÐµÑ: Ð³. ÐœÐ¾ÑÐºÐ²Ð°, ÑƒÐ». ÐŸÑ€Ð¸Ð¼ÐµÑ€Ð½Ð°Ñ, Ð´. 1"
        android:layout_marginBottom="24dp" />

    <Button
        android:id="@+id/payButton"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Payberry"
        android:textSize="16sp" />

</LinearLayout>
EOF

        # Create MainActivity with proper layout inflation
        cat > app/src/main/java/com/example/internetprovider/MainActivity.java << 'EOF'
package com.example.internetprovider;

import android.app.Activity;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;

public class MainActivity extends Activity {
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        Button payButton = findViewById(R.id.payButton);
        payButton.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent browserIntent = new Intent(Intent.ACTION_VIEW, Uri.parse("https://payberry.ru"));
                startActivity(browserIntent);
            }
        });
    }
}
EOF

        # Create R.java file manually since we don't have proper resource compilation
        cat > app/src/main/java/com/example/internetprovider/R.java << 'EOF'
package com.example.internetprovider;

public final class R {
    public static final class layout {
        public static final int activity_main = 0x7f030000;
    }
    public static final class id {
        public static final int payButton = 0x7f070000;
    }
    public static final class string {
        public static final int app_name = 0x7f040000;
    }
    public static final class mipmap {
        public static final int ic_launcher = 0x7f020000;
    }
}
EOF

        echo "âœ… Project structure created"
    
    - name: Build proper APK
      run: |
        cd app
        
        echo "ðŸ”§ Creating debug keystore..."
        keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
        
        echo "ðŸ”§ Compiling resources..."
        mkdir -p build/gen build/classes build/apk
        $ANDROID_HOME/build-tools/33.0.2/aapt2 compile src/main/res/layout/activity_main.xml -o build/res.zip
        $ANDROID_HOME/build-tools/33.0.2/aapt2 compile src/main/res/values/strings.xml -o build/res.zip
        
        echo "ðŸ”§ Linking resources..."
        $ANDROID_HOME/build-tools/33.0.2/aapt2 link -o build/resources.apk \
          -I $ANDROID_HOME/platforms/android-33/android.jar \
          --manifest src/main/AndroidManifest.xml \
          --java build/gen \
          build/res.zip
        
        echo "ðŸ”§ Compiling Java code..."
        javac -d build/classes \
          -cp "$ANDROID_HOME/platforms/android-33/android.jar:build/gen" \
          src/main/java/com/example/internetprovider/*.java \
          build/gen/com/example/internetprovider/*.java
        
        echo "ðŸ”§ Creating DEX file..."
        mkdir -p build/dex
        $ANDROID_HOME/build-tools/33.0.2/d8 \
          --lib $ANDROID_HOME/platforms/android-33/android.jar \
          --output build/dex \
          build/classes/com/example/internetprovider/*.class
        
        echo "ðŸ”§ Creating APK..."
        $ANDROID_HOME/build-tools/33.0.2/aapt package -F build/app-unsigned.apk \
          -I $ANDROID_HOME/platforms/android-33/android.jar \
          -M src/main/AndroidManifest.xml \
          -S src/main/res \
          -f
        
        echo "ðŸ”§ Adding DEX to APK..."
        cd build
        zip -uj app-unsigned.apk dex/classes.dex
        cd ..
        
        echo "ðŸ”§ Signing APK..."
        $ANDROID_HOME/build-tools/33.0.2/apksigner sign \
          --ks debug.keystore \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out build/app-debug.apk \
          build/app-unsigned.apk
        
        echo "ðŸ”§ Verifying APK..."
        $ANDROID_HOME/build-tools/33.0.2/aapt list build/app-debug.apk
        
        echo "âœ… APK built successfully!"
        ls -lh build/app-debug.apk
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: internet-provider-app
        path: app/build/app-debug.apk
        retention-days: 30
