name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        platforms: android-34
        cmdline-tools: latest
        
    - name: Install required packages
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip
        
    - name: Build APK with AAPT and D8
      run: |
        cd app
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤..."
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
        mkdir -p build/res
        
        # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º XML —Ä–µ—Å—É—Ä—Å—ã
        for xml_file in src/main/res/layout/*.xml; do
          if [ -f "$xml_file" ]; then
            echo "–ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º: $xml_file"
            $ANDROID_HOME/build-tools/34.0.0/aapt2 compile -o build/res "$xml_file"
          fi
        done
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è strings..."
        for xml_file in src/main/res/values/*.xml; do
          if [ -f "$xml_file" ]; then
            echo "–ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º: $xml_file"
            $ANDROID_HOME/build-tools/34.0.0/aapt2 compile -o build/res "$xml_file"
          fi
        done
        
        echo "üîß –õ–∏–Ω–∫–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o build/resources.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest AndroidManifest.xml \
          --java build/gen \
          build/res/*.flat
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è Java –∫–æ–¥–∞..."
        mkdir -p build/obj
        javac -d build/obj \
          -cp "src/main/java:$ANDROID_HOME/platforms/android-34/android.jar:build/gen" \
          -sourcepath src/main/java \
          src/main/java/com/example/internetprovider/*.java
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ DEX —Ñ–∞–π–ª–∞..."
        $ANDROID_HOME/build-tools/34.0.0/d8 \
          --lib $ANDROID_HOME/platforms/android-34/android.jar \
          --output build/ \
          build/obj/com/example/internetprovider/*.class
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ APK..."
        cp build/resources.apk build/app-unsigned.apk
        
        echo "üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DEX –≤ APK..."
        cd build && zip -uj app-unsigned.apk classes.dex && cd ..
        
        echo "üîß –ü–æ–¥–ø–∏—Å—ã–≤–∞–Ω–∏–µ APK..."
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
        keytool -genkey -v -keystore build/debug.keystore \
          -alias androiddebugkey -storepass android -keypass android \
          -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
        
        $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
          --ks build/debug.keystore \
          --ks-pass pass:android \
          --key-pass pass:android \
          --out app-debug.apk \
          build/app-unsigned.apk
        
        echo "‚úÖ APK —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω: app-debug.apk"
        ls -la app-debug.apk
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: internet-provider-app
        path: app/app-debug.apk
        retention-days: 30
