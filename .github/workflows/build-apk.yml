name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        
    - name: Build APK with AAPT and D8
      run: |
        cd app
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤..."
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
        mkdir -p build/res
        
        # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º XML —Ä–µ—Å—É—Ä—Å—ã –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        $ANDROID_HOME/build-tools/34.0.0/aapt2 compile src/main/res/layout/activity_main.xml -o build/res/
        $ANDROID_HOME/build-tools/34.0.0/aapt2 compile src/main/res/values/strings.xml -o build/res/
        
        echo "üîß –õ–∏–Ω–∫–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è R.java..."
        # –õ–∏–Ω–∫—É–µ–º —Ä–µ—Å—É—Ä—Å—ã –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º R.java
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o build/resources.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest src/main/AndroidManifest.xml \
          --java build/generated \
          build/res/*.flat
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è Java –∫–æ–¥–∞..."
        mkdir -p build/obj
        # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º Java –∫–æ–¥ –≤–∫–ª—é—á–∞—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π R.java
        javac -d build/obj \
          -cp "src/main/java:build/generated/com/example/internetprovider:$ANDROID_HOME/platforms/android-34/android.jar" \
          -sourcepath "src/main/java:build/generated" \
          src/main/java/com/example/internetprovider/MainActivity.java
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ DEX —Ñ–∞–π–ª–∞..."
        $ANDROID_HOME/build-tools/34.0.0/d8 \
          --lib $ANDROID_HOME/platforms/android-34/android.jar \
          --output build/ \
          build/obj/com/example/internetprovider/*.class
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ APK..."
        # –°–æ–∑–¥–∞–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π APK
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o build/app-debug.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest src/main/AndroidManifest.xml \
          build/res/*.flat
        
        echo "üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DEX –≤ APK..."
        cd build
        zip -uj app-debug.apk classes.dex
        cd ..
        
        echo "‚úÖ APK —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
        ls -la build/
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: internet-provider-app
        path: app/build/app-debug.apk
        retention-days: 30
