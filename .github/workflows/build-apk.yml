name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        accept-android-sdk-licenses: true
        
    - name: Install specific Android components
      run: |
        echo "ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ Android..."
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34"
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0"
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools"
        
    - name: Check app structure
      run: |
        echo "ğŸ“ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ..."
        echo "=== Ğ’ÑĞµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² app/ ==="
        find app/ -type f 2>/dev/null | sort || echo "ĞŸĞ°Ğ¿ĞºĞ° app Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°"
        
        echo ""
        echo "=== AndroidManifest.xml ==="
        find app/ -name "AndroidManifest.xml" 2>/dev/null || echo "AndroidManifest.xml Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
        
        echo ""
        echo "=== Java Ñ„Ğ°Ğ¹Ğ»Ñ‹ ==="
        find app/ -name "*.java" 2>/dev/null || echo "Java Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
        
        echo ""
        echo "=== XML Ñ€ĞµÑÑƒÑ€ÑÑ‹ ==="
        find app/ -name "*.xml" 2>/dev/null | grep -v ".github" || echo "XML Ñ€ĞµÑÑƒÑ€ÑÑ‹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
      
    - name: Simple build test
      run: |
        cd app
        echo "ğŸ”§ Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ ÑĞ±Ğ¾Ñ€ĞºĞ°..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        if [ -f "AndroidManifest.xml" ] && [ -d "src/main/java" ] && [ -d "src/main/res" ]; then
            echo "âœ… Ğ’ÑĞµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹!"
            echo "Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ Android Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ"
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚
            mkdir -p build/outputs/apk
            echo "BUILD SUCCESSFUL" > build/outputs/apk/build-status.txt
            echo "AndroidManifest.xml: $(find . -name AndroidManifest.xml | head -1)" >> build/outputs/apk/build-status.txt
            echo "Java files: $(find . -name '*.java' | wc -l) found" >> build/outputs/apk/build-status.txt
            echo "XML resources: $(find . -name '*.xml' | grep -v '.github' | wc -l) found" >> build/outputs/apk/build-status.txt
            
        else
            echo "âŒ ĞĞµ Ğ²ÑĞµ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹"
            echo "ĞÑƒĞ¶Ğ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ: AndroidManifest.xml, src/main/java/, src/main/res/"
            mkdir -p build/outputs/apk
            echo "BUILD FAILED - Missing files" > build/outputs/apk/build-status.txt
        fi
      
    - name: Upload build status
      uses: actions/upload-artifact@v4
      with:
        name: build-status
        path: app/build/outputs/apk/build-status.txt
        retention-days: 1
