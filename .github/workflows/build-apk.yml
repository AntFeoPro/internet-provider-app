name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Android SDK
      uses: android-actions/setup-android-sdk@v2.0.0
      with:
        api-level: 34
        build-tools: 34.0.0
        
    - name: Check app structure
      run: |
        echo "üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫..."
        find app/ -type f -name "*.xml" -o -name "*.java" | sort
        echo "AndroidManifest.xml –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ app/src/main/"
        
    - name: Build APK with AAPT and D8
      run: |
        cd app
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤..."
        mkdir -p build/res
        
        # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º —Ä–µ—Å—É—Ä—Å—ã –∏–∑ src/main/res/
        $ANDROID_HOME/build-tools/34.0.0/aapt2 compile src/main/res/layout/activity_main.xml -o build/res/
        $ANDROID_HOME/build-tools/34.0.0/aapt2 compile src/main/res/values/strings.xml -o build/res/
        
        echo "üîß –õ–∏–Ω–∫–æ–≤–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è R.java..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o build/resources.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest src/main/AndroidManifest.xml \
          --java build/generated \
          build/res/*.flat
        
        echo "üîß –ö–æ–º–ø–∏–ª—è—Ü–∏—è Java –∫–æ–¥–∞..."
        mkdir -p build/obj
        javac -d build/obj \
          -cp "src/main/java:build/generated/com/example/internetprovider:$ANDROID_HOME/platforms/android-34/android.jar" \
          -sourcepath "src/main/java:build/generated" \
          src/main/java/com/example/internetprovider/MainActivity.java
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ DEX —Ñ–∞–π–ª–∞..."
        $ANDROID_HOME/build-tools/34.0.0/d8 \
          --lib $ANDROID_HOME/platforms/android-34/android.jar \
          --output build/ \
          build/obj/com/example/internetprovider/*.class
        
        echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ APK..."
        $ANDROID_HOME/build-tools/34.0.0/aapt2 link -o build/app-debug.apk \
          -I $ANDROID_HOME/platforms/android-34/android.jar \
          --manifest src/main/AndroidManifest.xml \
          build/res/*.flat
        
        echo "üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DEX –≤ APK..."
        cd build
        zip -uj app-debug.apk classes.dex
        cd ..
        
        echo "‚úÖ APK —Å–æ–±—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ!"
        ls -la build/app-debug.apk
      
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: internet-provider-app
        path: app/build/app-debug.apk
        retention-days: 30
